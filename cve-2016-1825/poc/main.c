#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

#include "physic.h"


// string --> uint64_t
static uint64_t parse_u64(const char *str) {
	char *end;
	uint64_t value = strtoull(str, &end, 0);
	if (*str == 0 || *end != 0) {
		printf("invalid integer '%s'", str);
	}
	return value;
}

static void readmem(const char *addr) {
	uint64_t paddr = parse_u64(addr);
	uint64_t value;
	unsigned width = sizeof(value);

	physic_init();
	value = physic_read(paddr, width);
	printf("%0*llx\n", 2 * width, value);
}

static void writemem(const char *addr,const char *data) {
	uint64_t paddr = parse_u64(addr);
	uint64_t value = parse_u64(data);
	unsigned width = sizeof(value);

	physic_init();
	physic_write(paddr, value, width);
}

int main(int argc, const char *argv[]) {
	int sle=0;
	char addr[32],data[32];

	while(1){
		printf("Your choice:\n 0: read\n 1: write\n");
		scanf("%d",&sle);
		if (sle == 0) {						// read
			printf("read: addr\n");
			scanf("%s",addr);
			readmem(addr);
		} else if (sle == 1) {				// write
			printf("write: addr data\n");
			scanf("%s %s",addr,data);
			writemem(addr,data);
		} else {
			break;
		}
	}
	
	return 0;
}
